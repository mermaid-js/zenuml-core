<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UMD Compatibility Test - ZenUML v4.0.0</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-container {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .diagram-container {
            flex: 1;
            min-height: 300px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
        }
        .test-results {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { color: #008000; }
        .error { color: #ff0000; }
        .info { color: #0066cc; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .logs {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>üß™ UMD Compatibility Test - ZenUML v4.0.0</h1>
    <p><strong>Task 4:</strong> Verify UMD bundle compatibility for both access patterns</p>

    <div class="test-section">
        <h2>1. Global Variable Check</h2>
        <div class="test-results" id="global-check">
            <p>üîç Checking global variables...</p>
        </div>
    </div>

    <div class="test-section">
        <h2>2. Instance Creation Test</h2>
        <div class="test-results" id="instance-check">
            <p>üîç Testing instance creation...</p>
        </div>
        <button onclick="testInstanceCreation()">Run Instance Tests</button>
    </div>

    <div class="test-section">
        <h2>3. Rendering Comparison Test</h2>
        <p>Both patterns should render identical diagrams:</p>
        <div class="test-container">
            <div>
                <h4>window.zenuml (v3.34.0+ pattern)</h4>
                <div id="diagram1" class="diagram-container"></div>
            </div>
            <div>
                <h4>window.zenuml.default (v3.32.x pattern)</h4>
                <div id="diagram2" class="diagram-container"></div>
            </div>
        </div>
        <button onclick="testRendering()">Test Rendering</button>
        <button onclick="testComplexRendering()">Test Complex Diagram</button>
        <div class="test-results" id="render-results"></div>
    </div>

    <div class="test-section">
        <h2>4. Method Compatibility Test</h2>
        <div class="test-results" id="method-results"></div>
        <button onclick="testMethods()">Test Methods</button>
    </div>

    <div class="test-section">
        <h2>5. Timing & Race Condition Test</h2>
        <div class="test-results" id="timing-results"></div>
        <button onclick="testTiming()">Test Timing</button>
    </div>

    <div class="test-section">
        <h2>üìã Test Logs</h2>
        <div class="logs" id="logs"></div>
        <button onclick="clearLogs()">Clear Logs</button>
    </div>

    <!-- Load ZenUML UMD Bundle -->
    <script src="dist/zenuml.js"></script>

    <script>
        // Logging utility
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logs = document.getElementById('logs');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            logs.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // Test 1: Global Variable Check
        function checkGlobals() {
            const results = document.getElementById('global-check');
            let html = '';

            // Check if window.zenuml exists
            if (typeof window.zenuml !== 'undefined') {
                html += '<p class="success">‚úÖ window.zenuml exists</p>';
                log('window.zenuml exists', 'success');
                
                // Check if it's a function
                if (typeof window.zenuml === 'function') {
                    html += '<p class="success">‚úÖ window.zenuml is a function</p>';
                    log('window.zenuml is a function', 'success');
                } else {
                    html += '<p class="error">‚ùå window.zenuml is not a function</p>';
                    log('window.zenuml is not a function', 'error');
                }

                // Check version
                if (window.zenuml.version) {
                    html += `<p class="success">‚úÖ Version: ${window.zenuml.version}</p>`;
                    log(`ZenUML version: ${window.zenuml.version}`, 'success');
                }
            } else {
                html += '<p class="error">‚ùå window.zenuml does not exist</p>';
                log('window.zenuml does not exist', 'error');
            }

            // Check if window.zenuml.default exists (compatibility layer)
            if (typeof window.zenuml !== 'undefined' && typeof window.zenuml.default !== 'undefined') {
                html += '<p class="success">‚úÖ window.zenuml.default exists (compatibility layer working)</p>';
                log('window.zenuml.default exists - compatibility layer working', 'success');
                
                // Check if they reference the same function
                if (window.zenuml === window.zenuml.default) {
                    html += '<p class="success">‚úÖ window.zenuml === window.zenuml.default (reference equality)</p>';
                    log('Reference equality confirmed', 'success');
                } else {
                    html += '<p class="error">‚ùå window.zenuml !== window.zenuml.default</p>';
                    log('Reference equality failed', 'error');
                }
            } else {
                html += '<p class="error">‚ùå window.zenuml.default does not exist</p>';
                log('window.zenuml.default does not exist', 'error');
            }

            results.innerHTML = html;
        }

        // Test 2: Instance Creation
        function testInstanceCreation() {
            const results = document.getElementById('instance-check');
            let html = '';
            
            try {
                // Create test elements
                const testDiv1 = document.createElement('div');
                const testDiv2 = document.createElement('div');
                document.body.appendChild(testDiv1);
                document.body.appendChild(testDiv2);

                // Test window.zenuml
                const instance1 = new window.zenuml(testDiv1);
                html += '<p class="success">‚úÖ new window.zenuml() - instance created</p>';
                log('window.zenuml instance created successfully', 'success');

                // Test window.zenuml.default
                const instance2 = new window.zenuml.default(testDiv2);
                html += '<p class="success">‚úÖ new window.zenuml.default() - instance created</p>';
                log('window.zenuml.default instance created successfully', 'success');

                // Test constructor equality
                if (instance1.constructor === instance2.constructor) {
                    html += '<p class="success">‚úÖ Both instances have same constructor</p>';
                    log('Constructor equality confirmed', 'success');
                } else {
                    html += '<p class="error">‚ùå Instances have different constructors</p>';
                    log('Constructor equality failed', 'error');
                }

                // Test methods exist
                const methods = ['render', 'getPng', 'getSvg'];
                let allMethodsExist = true;
                for (const method of methods) {
                    if (typeof instance1[method] === 'function' && typeof instance2[method] === 'function') {
                        html += `<p class="success">‚úÖ Method ${method} exists on both instances</p>`;
                        log(`Method ${method} exists on both instances`, 'success');
                    } else {
                        html += `<p class="error">‚ùå Method ${method} missing on one or both instances</p>`;
                        log(`Method ${method} missing`, 'error');
                        allMethodsExist = false;
                    }
                }

                if (allMethodsExist) {
                    html += '<p class="success">‚úÖ All methods available on both instances</p>';
                    log('All methods available', 'success');
                }

                // Clean up
                document.body.removeChild(testDiv1);
                document.body.removeChild(testDiv2);

            } catch (error) {
                html += `<p class="error">‚ùå Error creating instances: ${error.message}</p>`;
                log(`Error creating instances: ${error.message}`, 'error');
            }

            results.innerHTML = html;
        }

        // Test 3: Rendering
        function testRendering() {
            const resultsDiv = document.getElementById('render-results');
            const testCode = 'A.method() {\n  B.process()\n  return result\n}';
            
            try {
                // Clear previous diagrams
                document.getElementById('diagram1').innerHTML = '';
                document.getElementById('diagram2').innerHTML = '';

                // Create instances
                const instance1 = new window.zenuml('#diagram1');
                const instance2 = new window.zenuml.default('#diagram2');

                log('Created instances for rendering test', 'info');

                // Render the same code
                Promise.all([
                    instance1.render(testCode, { theme: 'default' }),
                    instance2.render(testCode, { theme: 'default' })
                ]).then(([result1, result2]) => {
                    let html = '<p class="success">‚úÖ Both instances rendered successfully</p>';
                    
                    // Check if both returned the instance
                    if (result1 === instance1 && result2 === instance2) {
                        html += '<p class="success">‚úÖ render() returns instance (correct behavior)</p>';
                        log('render() method returns correct instance', 'success');
                    }

                    // Check if code was set correctly
                    if (instance1.code === testCode && instance2.code === testCode) {
                        html += '<p class="success">‚úÖ Code property set correctly on both instances</p>';
                        log('Code property set correctly', 'success');
                    }

                    // Check if theme was set correctly
                    if (instance1.theme === 'default' && instance2.theme === 'default') {
                        html += '<p class="success">‚úÖ Theme property set correctly on both instances</p>';
                        log('Theme property set correctly', 'success');
                    }

                    resultsDiv.innerHTML = html;
                    log('Rendering test completed successfully', 'success');
                }).catch(error => {
                    resultsDiv.innerHTML = `<p class="error">‚ùå Rendering failed: ${error.message}</p>`;
                    log(`Rendering failed: ${error.message}`, 'error');
                });

            } catch (error) {
                resultsDiv.innerHTML = `<p class="error">‚ùå Rendering test failed: ${error.message}</p>`;
                log(`Rendering test failed: ${error.message}`, 'error');
            }
        }

        function testComplexRendering() {
            const complexCode = `title Complex Sequence
@Actor User
@Database DB
@Service API

User->API: login(credentials) {
  API->DB: validateUser(username) {
    return userRecord
  }
  if (userRecord.valid) {
    API->DB: createSession() {
      return sessionId  
    }
    return {success: true, sessionId}
  } else {
    return {success: false, error: "Invalid credentials"}
  }
}`;

            try {
                const instance1 = new window.zenuml('#diagram1');
                const instance2 = new window.zenuml.default('#diagram2');

                Promise.all([
                    instance1.render(complexCode, { theme: 'blue' }),
                    instance2.render(complexCode, { theme: 'blue' })
                ]).then(() => {
                    const resultsDiv = document.getElementById('render-results');
                    resultsDiv.innerHTML = '<p class="success">‚úÖ Complex diagram rendered successfully on both instances</p>';
                    log('Complex diagram test completed', 'success');
                }).catch(error => {
                    log(`Complex rendering failed: ${error.message}`, 'error');
                });

            } catch (error) {
                log(`Complex rendering test failed: ${error.message}`, 'error');
            }
        }

        // Test 4: Method Compatibility
        function testMethods() {
            const results = document.getElementById('method-results');
            
            try {
                const testDiv1 = document.createElement('div');
                const testDiv2 = document.createElement('div');
                document.body.appendChild(testDiv1);
                document.body.appendChild(testDiv2);

                const instance1 = new window.zenuml(testDiv1);
                const instance2 = new window.zenuml.default(testDiv2);

                let html = '';

                // Test static properties
                if (window.zenuml.version === window.zenuml.default.version) {
                    html += '<p class="success">‚úÖ Static version property identical</p>';
                    log('Static version property identical', 'success');
                }

                // Test export methods exist (we don't call them due to async nature)
                const exportMethods = ['getPng', 'getSvg'];
                for (const method of exportMethods) {
                    if (typeof instance1[method] === 'function' && typeof instance2[method] === 'function') {
                        html += `<p class="success">‚úÖ Export method ${method} available on both</p>`;
                        log(`Export method ${method} available`, 'success');
                    }
                }

                // Test getters
                const getters = ['code', 'theme'];
                for (const getter of getters) {
                    if (instance1[getter] === instance2[getter]) {
                        html += `<p class="success">‚úÖ Getter ${getter} returns same value</p>`;
                        log(`Getter ${getter} consistent`, 'success');
                    }
                }

                html += '<p class="info">‚ÑπÔ∏è Export methods (getPng, getSvg) exist but not called in test to avoid complexity</p>';

                document.body.removeChild(testDiv1);
                document.body.removeChild(testDiv2);

                results.innerHTML = html;

            } catch (error) {
                results.innerHTML = `<p class="error">‚ùå Method test failed: ${error.message}</p>`;
                log(`Method test failed: ${error.message}`, 'error');
            }
        }

        // Test 5: Timing and Race Conditions
        function testTiming() {
            const results = document.getElementById('timing-results');
            
            log('Starting timing and race condition tests', 'info');

            // Test rapid successive calls
            try {
                const testDiv = document.createElement('div');
                document.body.appendChild(testDiv);

                // Test that compatibility layer is available immediately 
                const startTime = performance.now();
                
                // These should all work immediately without timing issues
                const instance1 = new window.zenuml(testDiv);
                const instance2 = new window.zenuml.default(testDiv);
                const hasDefault = !!window.zenuml.default;
                const isEqual = window.zenuml === window.zenuml.default;
                
                const endTime = performance.now();
                
                let html = '';
                if (hasDefault && isEqual) {
                    html += '<p class="success">‚úÖ No timing issues - compatibility layer available immediately</p>';
                    html += `<p class="info">‚ÑπÔ∏è Test completed in ${(endTime - startTime).toFixed(2)}ms</p>`;
                    log('No timing issues detected', 'success');
                } else {
                    html += '<p class="error">‚ùå Timing issue detected - compatibility layer not immediately available</p>';
                    log('Timing issue detected', 'error');
                }

                // Test multiple rapid instantiations
                const rapidTests = [];
                for (let i = 0; i < 5; i++) {
                    const div = document.createElement('div');
                    document.body.appendChild(div);
                    rapidTests.push(() => {
                        try {
                            new window.zenuml(div);
                            new window.zenuml.default(div);
                            document.body.removeChild(div);
                            return true;
                        } catch (e) {
                            return false;
                        }
                    });
                }

                const rapidResults = rapidTests.map(test => test());
                const allPassed = rapidResults.every(result => result);

                if (allPassed) {
                    html += '<p class="success">‚úÖ Rapid instantiation test passed (5 iterations)</p>';
                    log('Rapid instantiation test passed', 'success');
                } else {
                    html += '<p class="error">‚ùå Rapid instantiation test failed</p>';
                    log('Rapid instantiation test failed', 'error');
                }

                document.body.removeChild(testDiv);
                results.innerHTML = html;

            } catch (error) {
                results.innerHTML = `<p class="error">‚ùå Timing test failed: ${error.message}</p>`;
                log(`Timing test failed: ${error.message}`, 'error');
            }
        }

        // Run initial global check when page loads
        window.addEventListener('load', () => {
            log('Page loaded, running initial checks', 'info');
            checkGlobals();
        });

        // Log script load
        log('UMD Compatibility Test script loaded', 'info');
    </script>
</body>
</html> 